#!/bin/bash

BUILD_DIR=$1

indent() {
    sed -u 's/^/       /'
}

echo "-----> Found a .terraform_url file"

if [ ! -s $BUILD_DIR/.terraform_url ]; then
    echo ".terraform_url empty. Skipping." | indent
    exit 0
fi

UNZIP_COMMAND="unzip"

if [ $STACK == "cedar" ]; then
  UNZIP_COMMAND="jar xf"
fi

mkdir -p $BUILD_DIR/bin

echo "Reading urls"
while IFS='' read -r url || [[ -n "$url" ]]; do
  echo "Downloading Terraform from $url" | indent
  curl -L --silent $url > $BUILD_DIR/bin/terraform.zip
done < $BUILD_DIR/.terraform_url 

echo "Unzipping..." | indent
$UNZIP_COMMAND $BUILD_DIR/bin/terraform.zip
mv terraform $BUILD_DIR/bin/terraform
rm $BUILD_DIR/bin/terraform.zip
echo "Done"
